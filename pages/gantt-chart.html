<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”˜ç‰¹å›¾å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #e0f2f7 0%, #d4e8f0 50%, #c8e0ea 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2em;
            color: #333;
            margin-bottom: 10px;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #4a90e2;
            text-decoration: none;
            font-size: 0.9em;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #3a7bc8;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input[type="text"],
        input[type="date"],
        input[type="number"],
        input[type="color"],
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #4a90e2;
        }

        .tasks-panel {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .tasks-list {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            max-height: 600px;
            overflow-y: auto;
        }

        .task-item {
            background: white;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid #4a90e2;
            cursor: pointer;
            transition: all 0.3s;
        }

        .task-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .task-item.selected {
            border-left-color: #28a745;
            background: #f0fff4;
        }

        .task-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .task-dates {
            font-size: 0.85em;
            color: #666;
        }

        .task-progress {
            margin-top: 5px;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
        }

        .task-progress-bar {
            height: 100%;
            background: #28a745;
            transition: width 0.3s;
        }

        .chart-container {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            overflow-x: auto;
            position: relative;
        }

        #ganttCanvas {
            display: block;
            border: 1px solid #ddd;
        }

        .task-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row.full {
            grid-template-columns: 1fr;
        }

        .color-picker-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-picker-group input[type="color"] {
            width: 60px;
            height: 40px;
            padding: 2px;
            cursor: pointer;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 10px;
        }

        @media (max-width: 1024px) {
            .tasks-panel {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="../index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
            <h1>ğŸ“Š ç”˜ç‰¹å›¾å·¥å…·</h1>
        </div>

        <div class="toolbar">
            <button class="btn btn-success" onclick="addTask()">æ·»åŠ ä»»åŠ¡</button>
            <button class="btn btn-secondary" onclick="exportJSON()">å¯¼å‡ºJSON</button>
            <button class="btn btn-secondary" onclick="importJSON()">å¯¼å…¥JSON</button>
            <button class="btn btn-secondary" onclick="exportImage()">å¯¼å‡ºå›¾ç‰‡</button>
            <button class="btn btn-danger" onclick="clearAll()">æ¸…ç©ºæ‰€æœ‰</button>
        </div>

        <div class="task-form" id="taskForm" style="display: none;">
            <h3 style="margin-bottom: 15px;">ä»»åŠ¡ä¿¡æ¯</h3>
            <div class="form-row full">
                <div class="form-group">
                    <label>ä»»åŠ¡åç§°</label>
                    <input type="text" id="taskName" placeholder="è¾“å…¥ä»»åŠ¡åç§°">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>å¼€å§‹æ—¥æœŸ</label>
                    <input type="date" id="taskStartDate">
                </div>
                <div class="form-group">
                    <label>ç»“æŸæ—¥æœŸ</label>
                    <input type="date" id="taskEndDate">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>è¿›åº¦ (%)</label>
                    <input type="number" id="taskProgress" min="0" max="100" value="0">
                </div>
                <div class="form-group">
                    <label>é¢œè‰²</label>
                    <div class="color-picker-group">
                        <input type="color" id="taskColor" value="#4a90e2">
                        <input type="text" id="taskColorText" value="#4a90e2" readonly style="flex: 1;">
                    </div>
                </div>
            </div>
            <div class="toolbar">
                <button class="btn btn-success" onclick="saveTask()">ä¿å­˜</button>
                <button class="btn btn-secondary" onclick="cancelEdit()">å–æ¶ˆ</button>
            </div>
        </div>

        <div class="tasks-panel">
            <div class="tasks-list" id="tasksList">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“‹</div>
                    <p>æš‚æ— ä»»åŠ¡ï¼Œç‚¹å‡»"æ·»åŠ ä»»åŠ¡"å¼€å§‹</p>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="ganttCanvas"></canvas>
            </div>
        </div>
    </div>

    <script>
        let tasks = [];
        let selectedTaskIndex = -1;
        let editingTaskIndex = -1;
        let canvas, ctx;
        const TASK_HEIGHT = 40;
        const TASK_SPACING = 10;
        const HEADER_HEIGHT = 60;
        const LEFT_MARGIN = 150;
        const DAY_WIDTH = 30;
        const TODAY_COLOR = '#ff6b6b';

        // åˆå§‹åŒ–
        window.onload = function() {
            canvas = document.getElementById('ganttCanvas');
            ctx = canvas.getContext('2d');
            
            // è®¾ç½®é»˜è®¤æ—¥æœŸ
            const today = new Date();
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);
            
            document.getElementById('taskStartDate').value = formatDate(today);
            document.getElementById('taskEndDate').value = formatDate(nextWeek);

            // é¢œè‰²é€‰æ‹©å™¨åŒæ­¥
            document.getElementById('taskColor').addEventListener('input', function(e) {
                document.getElementById('taskColorText').value = e.target.value;
            });

            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½
            loadFromStorage();
            
            // åˆå§‹åŒ–ç”»å¸ƒ
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // ç»˜åˆ¶ç”˜ç‰¹å›¾
            drawGantt();
        };

        // æ ¼å¼åŒ–æ—¥æœŸä¸º YYYY-MM-DD
        function formatDate(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // è°ƒæ•´ç”»å¸ƒå¤§å°
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = Math.max(container.clientWidth - 40, 800);
            canvas.height = Math.max(tasks.length * (TASK_HEIGHT + TASK_SPACING) + HEADER_HEIGHT + 40, 400);
            drawGantt();
        }

        // æ·»åŠ ä»»åŠ¡
        function addTask() {
            editingTaskIndex = -1;
            document.getElementById('taskForm').style.display = 'block';
            document.getElementById('taskName').value = '';
            document.getElementById('taskProgress').value = 0;
            document.getElementById('taskColor').value = '#4a90e2';
            document.getElementById('taskColorText').value = '#4a90e2';
            
            const today = new Date();
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);
            document.getElementById('taskStartDate').value = formatDate(today);
            document.getElementById('taskEndDate').value = formatDate(nextWeek);
        }

        // ä¿å­˜ä»»åŠ¡
        function saveTask() {
            const name = document.getElementById('taskName').value.trim();
            const startDate = document.getElementById('taskStartDate').value;
            const endDate = document.getElementById('taskEndDate').value;
            const progress = parseInt(document.getElementById('taskProgress').value) || 0;
            const color = document.getElementById('taskColor').value;

            if (!name) {
                alert('è¯·è¾“å…¥ä»»åŠ¡åç§°');
                return;
            }

            if (!startDate || !endDate) {
                alert('è¯·é€‰æ‹©å¼€å§‹å’Œç»“æŸæ—¥æœŸ');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                alert('å¼€å§‹æ—¥æœŸä¸èƒ½æ™šäºç»“æŸæ—¥æœŸ');
                return;
            }

            const task = {
                name: name,
                startDate: startDate,
                endDate: endDate,
                progress: progress,
                color: color
            };

            if (editingTaskIndex >= 0) {
                tasks[editingTaskIndex] = task;
            } else {
                tasks.push(task);
            }

            document.getElementById('taskForm').style.display = 'none';
            saveToStorage();
            renderTasksList();
            resizeCanvas();
            drawGantt();
        }

        // å–æ¶ˆç¼–è¾‘
        function cancelEdit() {
            document.getElementById('taskForm').style.display = 'none';
            editingTaskIndex = -1;
        }

        // ç¼–è¾‘ä»»åŠ¡
        function editTask(index) {
            editingTaskIndex = index;
            const task = tasks[index];
            
            document.getElementById('taskName').value = task.name;
            document.getElementById('taskStartDate').value = task.startDate;
            document.getElementById('taskEndDate').value = task.endDate;
            document.getElementById('taskProgress').value = task.progress;
            document.getElementById('taskColor').value = task.color;
            document.getElementById('taskColorText').value = task.color;
            
            document.getElementById('taskForm').style.display = 'block';
            document.getElementById('taskForm').scrollIntoView({ behavior: 'smooth' });
        }

        // åˆ é™¤ä»»åŠ¡
        function deleteTask(index, event) {
            event.stopPropagation();
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) {
                tasks.splice(index, 1);
                saveToStorage();
                renderTasksList();
                resizeCanvas();
                drawGantt();
            }
        }

        // é€‰æ‹©ä»»åŠ¡
        function selectTask(index) {
            selectedTaskIndex = index;
            renderTasksList();
            drawGantt();
        }

        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        function renderTasksList() {
            const list = document.getElementById('tasksList');
            
            if (tasks.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“‹</div>
                        <p>æš‚æ— ä»»åŠ¡ï¼Œç‚¹å‡»"æ·»åŠ ä»»åŠ¡"å¼€å§‹</p>
                    </div>
                `;
                return;
            }

            list.innerHTML = tasks.map((task, index) => `
                <div class="task-item ${index === selectedTaskIndex ? 'selected' : ''}" 
                     onclick="selectTask(${index})">
                    <div class="task-name">${escapeHtml(task.name)}</div>
                    <div class="task-dates">
                        ${task.startDate} ~ ${task.endDate}
                    </div>
                    <div class="task-progress">
                        <div class="task-progress-bar" style="width: ${task.progress}%; background: ${task.color};"></div>
                    </div>
                    <div style="margin-top: 8px; display: flex; gap: 5px;">
                        <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.85em;" 
                                onclick="editTask(${index}); event.stopPropagation();">ç¼–è¾‘</button>
                        <button class="btn btn-danger" style="padding: 5px 10px; font-size: 0.85em;" 
                                onclick="deleteTask(${index}, event)">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }

        // ç»˜åˆ¶ç”˜ç‰¹å›¾
        function drawGantt() {
            if (tasks.length === 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '20px Arial';
                ctx.fillStyle = '#999';
                ctx.textAlign = 'center';
                ctx.fillText('æš‚æ— ä»»åŠ¡æ•°æ®', canvas.width / 2, canvas.height / 2);
                return;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // è®¡ç®—æ—¥æœŸèŒƒå›´
            let minDate = new Date(Math.min(...tasks.map(t => new Date(t.startDate).getTime())));
            let maxDate = new Date(Math.max(...tasks.map(t => new Date(t.endDate).getTime())));
            
            // æ‰©å±•æ—¥æœŸèŒƒå›´ï¼ˆå‰åå„åŠ 7å¤©ï¼‰
            minDate.setDate(minDate.getDate() - 7);
            maxDate.setDate(maxDate.getDate() + 7);

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // ç»˜åˆ¶æ—¶é—´è½´
            drawTimeAxis(minDate, maxDate, today);

            // ç»˜åˆ¶ä»»åŠ¡æ¡
            tasks.forEach((task, index) => {
                const y = HEADER_HEIGHT + index * (TASK_HEIGHT + TASK_SPACING) + TASK_SPACING;
                drawTaskBar(task, minDate, y, index === selectedTaskIndex);
            });
        }

        // ç»˜åˆ¶æ—¶é—´è½´
        function drawTimeAxis(minDate, maxDate, today) {
            const days = Math.ceil((maxDate - minDate) / (1000 * 60 * 60 * 24));
            
            // ç»˜åˆ¶èƒŒæ™¯
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(LEFT_MARGIN, 0, canvas.width - LEFT_MARGIN, HEADER_HEIGHT);

            // ç»˜åˆ¶ç½‘æ ¼çº¿
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            
            for (let i = 0; i <= days; i++) {
                const date = new Date(minDate);
                date.setDate(minDate.getDate() + i);
                const x = LEFT_MARGIN + i * DAY_WIDTH;

                // ä»Šå¤©æ ‡è®°
                if (date.getTime() === today.getTime()) {
                    ctx.fillStyle = TODAY_COLOR;
                    ctx.fillRect(x, 0, DAY_WIDTH, HEADER_HEIGHT);
                }

                // å‚ç›´çº¿
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();

                // æ—¥æœŸæ ‡ç­¾
                if (i % 7 === 0 || i === 0 || i === days) {
                    ctx.fillStyle = '#333';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(formatDateShort(date), x + DAY_WIDTH / 2, 20);
                    
                    // æ˜ŸæœŸæ ‡ç­¾
                    ctx.fillStyle = '#666';
                    ctx.font = '10px Arial';
                    ctx.fillText(getWeekday(date), x + DAY_WIDTH / 2, 40);
                }
            }

            // ç»˜åˆ¶ä»»åŠ¡åç§°åŒºåŸŸ
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, LEFT_MARGIN, canvas.height);
            
            ctx.strokeStyle = '#e0e0e0';
            ctx.beginPath();
            ctx.moveTo(LEFT_MARGIN, 0);
            ctx.lineTo(LEFT_MARGIN, canvas.height);
            ctx.stroke();
        }

        // ç»˜åˆ¶ä»»åŠ¡æ¡
        function drawTaskBar(task, minDate, y, isSelected) {
            const startDate = new Date(task.startDate);
            const endDate = new Date(task.endDate);
            const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            
            const startX = LEFT_MARGIN + Math.ceil((startDate - minDate) / (1000 * 60 * 60 * 24)) * DAY_WIDTH;
            const width = days * DAY_WIDTH;
            const progressWidth = width * (task.progress / 100);

            // ä»»åŠ¡æ¡èƒŒæ™¯
            ctx.fillStyle = task.color + '40'; // 40% é€æ˜åº¦
            ctx.fillRect(startX, y, width, TASK_HEIGHT);

            // è¿›åº¦æ¡
            if (task.progress > 0) {
                ctx.fillStyle = task.color;
                ctx.fillRect(startX, y, progressWidth, TASK_HEIGHT);
            }

            // è¾¹æ¡†
            ctx.strokeStyle = isSelected ? '#28a745' : task.color;
            ctx.lineWidth = isSelected ? 3 : 2;
            ctx.strokeRect(startX, y, width, TASK_HEIGHT);

            // ä»»åŠ¡åç§°
            ctx.fillStyle = '#333';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(task.name, 10, y + TASK_HEIGHT / 2 + 5);

            // æ—¥æœŸæ ‡ç­¾
            ctx.fillStyle = '#666';
            ctx.font = '10px Arial';
            ctx.fillText(`${task.startDate} ~ ${task.endDate}`, startX + 5, y + 15);
            
            // è¿›åº¦æ ‡ç­¾
            if (task.progress > 0) {
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 11px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(`${task.progress}%`, startX + progressWidth / 2, y + TASK_HEIGHT / 2 + 4);
            }
        }

        // æ ¼å¼åŒ–æ—¥æœŸï¼ˆçŸ­æ ¼å¼ï¼‰
        function formatDateShort(date) {
            const month = date.getMonth() + 1;
            const day = date.getDate();
            return `${month}/${day}`;
        }

        // è·å–æ˜ŸæœŸ
        function getWeekday(date) {
            const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            return 'å‘¨' + weekdays[date.getDay()];
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // å¯¼å‡ºJSON
        function exportJSON() {
            const data = JSON.stringify(tasks, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'gantt-chart.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // å¯¼å…¥JSON
        function importJSON() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (Array.isArray(data)) {
                                tasks = data;
                                saveToStorage();
                                renderTasksList();
                                resizeCanvas();
                                drawGantt();
                                alert('å¯¼å…¥æˆåŠŸï¼');
                            } else {
                                alert('æ— æ•ˆçš„JSONæ ¼å¼');
                            }
                        } catch (err) {
                            alert('è§£æJSONå¤±è´¥: ' + err.message);
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // å¯¼å‡ºå›¾ç‰‡
        function exportImage() {
            const link = document.createElement('a');
            link.download = 'gantt-chart.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        // æ¸…ç©ºæ‰€æœ‰
        function clearAll() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ä»»åŠ¡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                tasks = [];
                selectedTaskIndex = -1;
                editingTaskIndex = -1;
                saveToStorage();
                renderTasksList();
                resizeCanvas();
                drawGantt();
            }
        }

        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        function saveToStorage() {
            localStorage.setItem('ganttTasks', JSON.stringify(tasks));
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½
        function loadFromStorage() {
            const saved = localStorage.getItem('ganttTasks');
            if (saved) {
                try {
                    tasks = JSON.parse(saved);
                    renderTasksList();
                } catch (e) {
                    console.error('åŠ è½½æ•°æ®å¤±è´¥:', e);
                }
            }
        }
    </script>
</body>
</html>

