<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°å›¾ç»çº¬åº¦å·¥å…·</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #e0f2f7 0%, #d4e8f0 50%, #c8e0ea 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2em;
            color: #333;
            margin-bottom: 10px;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #4a90e2;
            text-decoration: none;
            font-size: 0.9em;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .main-content {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel-section {
            background: #f5f7fa;
            border-radius: 8px;
            padding: 20px;
        }

        .section-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
            font-size: 0.9em;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.9em;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #4a90e2;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 10px;
        }

        .btn:hover {
            background: #3a7bc8;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .coordinate-display {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            word-break: break-all;
            margin-top: 10px;
        }

        .coordinate-item {
            margin-bottom: 8px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .coordinate-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }

        .coordinate-value {
            color: #333;
            font-weight: bold;
        }

        .map-container {
            height: 600px;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e0e0e0;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 12px;
            border-radius: 4px;
            font-size: 0.85em;
            color: #666;
            margin-top: 15px;
        }

        .history-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .history-item {
            padding: 8px;
            background: white;
            border-radius: 4px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.85em;
        }

        .history-item:hover {
            background: #e9ecef;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .map-container {
                height: 400px;
            }
            .container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
        <div class="header">
            <h1>ğŸ—ºï¸ åœ°å›¾ç»çº¬åº¦å·¥å…·</h1>
        </div>

        <div class="main-content">
            <div class="control-panel">
                <!-- åæ ‡é‡‡é›† -->
                <div class="panel-section">
                    <div class="section-title">ğŸ“ åæ ‡é‡‡é›†</div>
                    <div class="form-group">
                        <label>ç‚¹å‡»åœ°å›¾è·å–åæ ‡</label>
                        <div class="coordinate-display" id="currentCoordinate">
                            <div class="coordinate-item">
                                <div class="coordinate-label">ç»åº¦ (Lng)</div>
                                <div class="coordinate-value" id="currentLng">--</div>
                            </div>
                            <div class="coordinate-item">
                                <div class="coordinate-label">çº¬åº¦ (Lat)</div>
                                <div class="coordinate-value" id="currentLat">--</div>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="copyCurrentCoordinate()">å¤åˆ¶å½“å‰åæ ‡</button>
                </div>

                <!-- åæ ‡å®šä½ -->
                <div class="panel-section">
                    <div class="section-title">ğŸ” åæ ‡å®šä½</div>
                    <div class="form-group">
                        <label>ç»åº¦ (Lng)</label>
                        <input type="number" id="inputLng" placeholder="ä¾‹å¦‚ï¼š116.397428" step="0.000001">
                    </div>
                    <div class="form-group">
                        <label>çº¬åº¦ (Lat)</label>
                        <input type="number" id="inputLat" placeholder="ä¾‹å¦‚ï¼š39.90923" step="0.000001">
                    </div>
                    <button class="btn" onclick="locateCoordinate()">å®šä½åˆ°åœ°å›¾</button>
                </div>

                <!-- åœ°å€è½¬ç»çº¬åº¦ -->
                <div class="panel-section">
                    <div class="section-title">ğŸ“ åœ°å€è½¬ç»çº¬åº¦</div>
                    <div class="form-group">
                        <label>åœ°å€</label>
                        <input type="text" id="inputAddress" placeholder="ä¾‹å¦‚ï¼šåŒ—äº¬å¸‚å¤©å®‰é—¨å¹¿åœº" onkeypress="if(event.key==='Enter') geocodeAddress()">
                    </div>
                    <button class="btn" onclick="geocodeAddress()" id="geocodeBtn">æŸ¥è¯¢åœ°å€</button>
                    <div class="coordinate-display" id="geocodeResult" style="display: none; margin-top: 10px;">
                        <div class="coordinate-item">
                            <div class="coordinate-label">ç»åº¦ (Lng)</div>
                            <div class="coordinate-value" id="geocodeLng">--</div>
                        </div>
                        <div class="coordinate-item">
                            <div class="coordinate-label">çº¬åº¦ (Lat)</div>
                            <div class="coordinate-value" id="geocodeLat">--</div>
                        </div>
                        <div class="coordinate-item" id="geocodeAddressDisplay" style="display: none;">
                            <div class="coordinate-label">è¯¦ç»†åœ°å€</div>
                            <div class="coordinate-value" id="geocodeAddressText" style="font-size: 0.85em; font-weight: normal;"></div>
                        </div>
                    </div>
                    <div id="geocodeLoading" style="display: none; text-align: center; color: #4a90e2; margin-top: 10px; padding: 10px;">
                        <div style="display: inline-block; width: 16px; height: 16px; border: 2px solid #4a90e2; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px;"></div>
                        æ­£åœ¨æŸ¥è¯¢åœ°å€...
                    </div>
                </div>

                <!-- åæ ‡ç³»è½¬æ¢ -->
                <div class="panel-section">
                    <div class="section-title">ğŸ”„ åæ ‡ç³»è½¬æ¢</div>
                    <div class="form-group">
                        <label>æºåæ ‡ç³»</label>
                        <select id="sourceSystem">
                            <option value="WGS84">WGS84 (GPSåæ ‡)</option>
                            <option value="GCJ02" selected>GCJ02 (ç«æ˜Ÿåæ ‡/é«˜å¾·)</option>
                            <option value="BD09">BD09 (ç™¾åº¦åæ ‡)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ç›®æ ‡åæ ‡ç³»</label>
                        <select id="targetSystem">
                            <option value="WGS84">WGS84 (GPSåæ ‡)</option>
                            <option value="GCJ02">GCJ02 (ç«æ˜Ÿåæ ‡/é«˜å¾·)</option>
                            <option value="BD09" selected>BD09 (ç™¾åº¦åæ ‡)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ç»åº¦</label>
                        <input type="number" id="convertLng" placeholder="è¾“å…¥ç»åº¦" step="0.000001">
                    </div>
                    <div class="form-group">
                        <label>çº¬åº¦</label>
                        <input type="number" id="convertLat" placeholder="è¾“å…¥çº¬åº¦" step="0.000001">
                    </div>
                    <button class="btn" onclick="convertCoordinate()">è½¬æ¢åæ ‡</button>
                    <div class="coordinate-display" id="convertResult" style="display: none;">
                        <div class="coordinate-item">
                            <div class="coordinate-label">è½¬æ¢åç»åº¦</div>
                            <div class="coordinate-value" id="convertedLng">--</div>
                        </div>
                        <div class="coordinate-item">
                            <div class="coordinate-label">è½¬æ¢åçº¬åº¦</div>
                            <div class="coordinate-value" id="convertedLat">--</div>
                        </div>
                    </div>
                </div>

                <!-- å†å²è®°å½• -->
                <div class="panel-section">
                    <div class="section-title">ğŸ“‹ å†å²è®°å½•</div>
                    <button class="btn btn-secondary" onclick="clearHistory()">æ¸…ç©ºå†å²</button>
                    <div class="history-list" id="historyList"></div>
                </div>

                <div class="info-box">
                    <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
                    â€¢ ç‚¹å‡»åœ°å›¾ä¸Šçš„ä»»æ„ä½ç½®è·å–åæ ‡<br>
                    â€¢ è¾“å…¥åæ ‡å¯å®šä½åˆ°åœ°å›¾ä¸Š<br>
                    â€¢ è¾“å…¥åœ°å€å¯è½¬æ¢ä¸ºç»çº¬åº¦å¹¶å®šä½<br>
                    â€¢ æ”¯æŒWGS84ã€GCJ02ã€BD09åæ ‡ç³»è½¬æ¢<br>
                    â€¢ åæ ‡ä¼šè‡ªåŠ¨ä¿å­˜åˆ°å†å²è®°å½•<br>
                    â€¢ åœ°å€æŸ¥è¯¢ä½¿ç”¨Nominatim APIï¼ˆæœ‰é¢‘ç‡é™åˆ¶ï¼‰
                </div>
            </div>

            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <script>
        let map;
        let marker;
        let history = JSON.parse(localStorage.getItem('coordinateHistory') || '[]');

        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            // é»˜è®¤å®šä½åˆ°åŒ—äº¬
            map = L.map('map').setView([39.90923, 116.397428], 13);

            // æ·»åŠ OpenStreetMapå›¾å±‚
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            map.on('click', function(e) {
                const lat = e.latlng.lat;
                const lng = e.latlng.lng;
                updateCurrentCoordinate(lat, lng);
                addMarker(lat, lng);
                addToHistory(lat, lng);
            });

            // åŠ è½½å†å²è®°å½•
            renderHistory();
        }

        // æ›´æ–°å½“å‰åæ ‡æ˜¾ç¤º
        function updateCurrentCoordinate(lat, lng) {
            document.getElementById('currentLat').textContent = lat.toFixed(6);
            document.getElementById('currentLng').textContent = lng.toFixed(6);
        }

        // æ·»åŠ æ ‡è®°
        function addMarker(lat, lng) {
            if (marker) {
                map.removeLayer(marker);
            }
            marker = L.marker([lat, lng]).addTo(map);
            marker.bindPopup(`åæ ‡ï¼š${lng.toFixed(6)}, ${lat.toFixed(6)}`).openPopup();
        }

        // å®šä½åˆ°æŒ‡å®šåæ ‡
        function locateCoordinate() {
            const lng = parseFloat(document.getElementById('inputLng').value);
            const lat = parseFloat(document.getElementById('inputLat').value);

            if (isNaN(lng) || isNaN(lat)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ç»çº¬åº¦');
                return;
            }

            if (lng < -180 || lng > 180 || lat < -90 || lat > 90) {
                alert('ç»çº¬åº¦è¶…å‡ºæœ‰æ•ˆèŒƒå›´\nç»åº¦ï¼š-180 åˆ° 180\nçº¬åº¦ï¼š-90 åˆ° 90');
                return;
            }

            map.setView([lat, lng], 15);
            addMarker(lat, lng);
            updateCurrentCoordinate(lat, lng);
            addToHistory(lat, lng);
        }

        // å¤åˆ¶å½“å‰åæ ‡
        function copyCurrentCoordinate() {
            const lng = document.getElementById('currentLng').textContent;
            const lat = document.getElementById('currentLat').textContent;

            if (lng === '--' || lat === '--') {
                alert('è¯·å…ˆç‚¹å‡»åœ°å›¾è·å–åæ ‡');
                return;
            }

            const text = `${lng}, ${lat}`;
            navigator.clipboard.writeText(text).then(() => {
                alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼š' + text);
            }).catch(() => {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            });
        }

        // åæ ‡ç³»è½¬æ¢ç®—æ³•
        const PI = Math.PI;
        const X_PI = PI * 3000.0 / 180.0;

        // GCJ02è½¬WGS84
        function gcj02ToWgs84(lng, lat) {
            let dlat = transformLat(lng - 105.0, lat - 35.0);
            let dlng = transformLng(lng - 105.0, lat - 35.0);
            let radlat = lat / 180.0 * PI;
            let magic = Math.sin(radlat);
            magic = 1 - 0.00669342162296594323 * magic * magic;
            let sqrtmagic = Math.sqrt(magic);
            dlat = (dlat * 180.0) / ((6378245.0 * (1 - 0.00669342162296594323)) / (magic * sqrtmagic) * PI);
            dlng = (dlng * 180.0) / (6378245.0 / sqrtmagic * Math.cos(radlat) * PI);
            let mglat = lat + dlat;
            let mglng = lng + dlng;
            return [lng * 2 - mglng, lat * 2 - mglat];
        }

        // WGS84è½¬GCJ02
        function wgs84ToGcj02(lng, lat) {
            let dlat = transformLat(lng - 105.0, lat - 35.0);
            let dlng = transformLng(lng - 105.0, lat - 35.0);
            let radlat = lat / 180.0 * PI;
            let magic = Math.sin(radlat);
            magic = 1 - 0.00669342162296594323 * magic * magic;
            let sqrtmagic = Math.sqrt(magic);
            dlat = (dlat * 180.0) / ((6378245.0 * (1 - 0.00669342162296594323)) / (magic * sqrtmagic) * PI);
            dlng = (dlng * 180.0) / (6378245.0 / sqrtmagic * Math.cos(radlat) * PI);
            return [lng + dlng, lat + dlat];
        }

        // GCJ02è½¬BD09
        function gcj02ToBd09(lng, lat) {
            let z = Math.sqrt(lng * lng + lat * lat) + 0.00002 * Math.sin(lat * X_PI);
            let theta = Math.atan2(lat, lng) + 0.000003 * Math.cos(lng * X_PI);
            return [z * Math.cos(theta) + 0.0065, z * Math.sin(theta) + 0.006];
        }

        // BD09è½¬GCJ02
        function bd09ToGcj02(lng, lat) {
            let x = lng - 0.0065;
            let y = lat - 0.006;
            let z = Math.sqrt(x * x + y * y) - 0.00002 * Math.sin(y * X_PI);
            let theta = Math.atan2(y, x) - 0.000003 * Math.cos(x * X_PI);
            return [z * Math.cos(theta), z * Math.sin(theta)];
        }

        // WGS84è½¬BD09
        function wgs84ToBd09(lng, lat) {
            const gcj02 = wgs84ToGcj02(lng, lat);
            return gcj02ToBd09(gcj02[0], gcj02[1]);
        }

        // BD09è½¬WGS84
        function bd09ToWgs84(lng, lat) {
            const gcj02 = bd09ToGcj02(lng, lat);
            return gcj02ToWgs84(gcj02[0], gcj02[1]);
        }

        function transformLat(lng, lat) {
            let ret = -100.0 + 2.0 * lng + 3.0 * lat + 0.2 * lat * lat + 0.1 * lng * lat + 0.2 * Math.sqrt(Math.abs(lng));
            ret += (20.0 * Math.sin(6.0 * lng * PI) + 20.0 * Math.sin(2.0 * lng * PI)) * 2.0 / 3.0;
            ret += (20.0 * Math.sin(lat * PI) + 40.0 * Math.sin(lat / 3.0 * PI)) * 2.0 / 3.0;
            ret += (160.0 * Math.sin(lat / 12.0 * PI) + 320 * Math.sin(lat * PI / 30.0)) * 2.0 / 3.0;
            return ret;
        }

        function transformLng(lng, lat) {
            let ret = 300.0 + lng + 2.0 * lat + 0.1 * lng * lng + 0.1 * lng * lat + 0.1 * Math.sqrt(Math.abs(lng));
            ret += (20.0 * Math.sin(6.0 * lng * PI) + 20.0 * Math.sin(2.0 * lng * PI)) * 2.0 / 3.0;
            ret += (20.0 * Math.sin(lng * PI) + 40.0 * Math.sin(lng / 3.0 * PI)) * 2.0 / 3.0;
            ret += (150.0 * Math.sin(lng / 12.0 * PI) + 300.0 * Math.sin(lng / 30.0 * PI)) * 2.0 / 3.0;
            return ret;
        }

        // åæ ‡è½¬æ¢
        function convertCoordinate() {
            const sourceSystem = document.getElementById('sourceSystem').value;
            const targetSystem = document.getElementById('targetSystem').value;
            const lng = parseFloat(document.getElementById('convertLng').value);
            const lat = parseFloat(document.getElementById('convertLat').value);

            if (isNaN(lng) || isNaN(lat)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„ç»çº¬åº¦');
                return;
            }

            if (sourceSystem === targetSystem) {
                alert('æºåæ ‡ç³»å’Œç›®æ ‡åæ ‡ç³»ç›¸åŒï¼Œæ— éœ€è½¬æ¢');
                return;
            }

            let result = [lng, lat];

            // å…ˆè½¬æ¢ä¸ºWGS84
            if (sourceSystem === 'GCJ02') {
                result = gcj02ToWgs84(lng, lat);
            } else if (sourceSystem === 'BD09') {
                result = bd09ToWgs84(lng, lat);
            }

            // å†ä»WGS84è½¬æ¢ä¸ºç›®æ ‡åæ ‡ç³»
            if (targetSystem === 'GCJ02') {
                result = wgs84ToGcj02(result[0], result[1]);
            } else if (targetSystem === 'BD09') {
                result = wgs84ToBd09(result[0], result[1]);
            }

            document.getElementById('convertedLng').textContent = result[0].toFixed(6);
            document.getElementById('convertedLat').textContent = result[1].toFixed(6);
            document.getElementById('convertResult').style.display = 'block';
        }

        // æ·»åŠ åˆ°å†å²è®°å½•
        function addToHistory(lat, lng) {
            const item = {
                lat: lat.toFixed(6),
                lng: lng.toFixed(6),
                time: new Date().toLocaleString('zh-CN')
            };
            history.unshift(item);
            if (history.length > 50) {
                history = history.slice(0, 50);
            }
            localStorage.setItem('coordinateHistory', JSON.stringify(history));
            renderHistory();
        }

        // æ¸²æŸ“å†å²è®°å½•
        function renderHistory() {
            const list = document.getElementById('historyList');
            if (history.length === 0) {
                list.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— å†å²è®°å½•</div>';
                return;
            }

            list.innerHTML = history.map((item, index) => {
                return `<div class="history-item" onclick="useHistory(${index})">
                    <div style="font-weight: bold; margin-bottom: 3px;">${item.lng}, ${item.lat}</div>
                    <div style="font-size: 0.8em; color: #999;">${item.time}</div>
                </div>`;
            }).join('');
        }

        // ä½¿ç”¨å†å²è®°å½•
        function useHistory(index) {
            const item = history[index];
            document.getElementById('inputLng').value = item.lng;
            document.getElementById('inputLat').value = item.lat;
            locateCoordinate();
        }

        // æ¸…ç©ºå†å²è®°å½•
        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ')) {
                history = [];
                localStorage.setItem('coordinateHistory', JSON.stringify(history));
                renderHistory();
            }
        }

        // åœ°å€è½¬ç»çº¬åº¦ï¼ˆåœ°ç†ç¼–ç ï¼‰
        async function geocodeAddress() {
            const address = document.getElementById('inputAddress').value.trim();
            
            if (!address) {
                alert('è¯·è¾“å…¥åœ°å€');
                return;
            }

            const btn = document.getElementById('geocodeBtn');
            const loading = document.getElementById('geocodeLoading');
            const result = document.getElementById('geocodeResult');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            btn.disabled = true;
            btn.textContent = 'æŸ¥è¯¢ä¸­...';
            loading.style.display = 'block';
            result.style.display = 'none';

            try {
                // ä½¿ç”¨Nominatim APIè¿›è¡Œåœ°ç†ç¼–ç 
                // æ³¨æ„ï¼šNominatimæœ‰ä½¿ç”¨é™åˆ¶ï¼Œè¯·åˆç†ä½¿ç”¨
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1&addressdetails=1`;
                
                const response = await fetch(url, {
                    headers: {
                        'User-Agent': 'MapCoordinateTool/1.0' // Nominatimè¦æ±‚è®¾ç½®User-Agent
                    }
                });

                if (!response.ok) {
                    throw new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
                }

                const data = await response.json();

                if (data.length === 0) {
                    alert('æœªæ‰¾åˆ°è¯¥åœ°å€ï¼Œè¯·å°è¯•æ›´è¯¦ç»†çš„åœ°å€æè¿°');
                    btn.disabled = false;
                    btn.textContent = 'æŸ¥è¯¢åœ°å€';
                    loading.style.display = 'none';
                    return;
                }

                const result_data = data[0];
                const lat = parseFloat(result_data.lat);
                const lng = parseFloat(result_data.lon);
                const displayName = result_data.display_name || address;

                // æ˜¾ç¤ºç»“æœ
                document.getElementById('geocodeLng').textContent = lng.toFixed(6);
                document.getElementById('geocodeLat').textContent = lat.toFixed(6);
                document.getElementById('geocodeAddressText').textContent = displayName;
                document.getElementById('geocodeAddressDisplay').style.display = 'block';
                result.style.display = 'block';

                // å®šä½åˆ°åœ°å›¾
                map.setView([lat, lng], 15);
                addMarker(lat, lng);
                updateCurrentCoordinate(lat, lng);
                addToHistory(lat, lng);

                // è‡ªåŠ¨å¡«å……åˆ°åæ ‡å®šä½è¾“å…¥æ¡†
                document.getElementById('inputLng').value = lng.toFixed(6);
                document.getElementById('inputLat').value = lat.toFixed(6);

            } catch (error) {
                console.error('åœ°ç†ç¼–ç é”™è¯¯:', error);
                alert('æŸ¥è¯¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•\n\næç¤ºï¼šNominatim APIæœ‰ä½¿ç”¨é¢‘ç‡é™åˆ¶ï¼Œè¯·å‹¿é¢‘ç¹è¯·æ±‚');
            } finally {
                btn.disabled = false;
                btn.textContent = 'æŸ¥è¯¢åœ°å€';
                loading.style.display = 'none';
            }
        }

        // åˆå§‹åŒ–
        initMap();
    </script>
</body>
</html>

