<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡å¤„ç†å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #e0f2f7 0%, #d4e8f0 50%, #c8e0ea 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2em;
            color: #333;
            margin-bottom: 10px;
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #4a90e2;
            text-decoration: none;
            font-size: 0.9em;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1em;
            color: #666;
            transition: all 0.3s;
        }

        .tab.active {
            color: #4a90e2;
            border-bottom-color: #4a90e2;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .upload-area {
            border: 2px dashed #4a90e2;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }

        .upload-area:hover {
            background: #e9ecef;
            border-color: #3a7bc8;
        }

        .upload-area.dragover {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .upload-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .upload-text {
            color: #666;
            margin-top: 10px;
        }

        #fileInput {
            display: none;
        }

        .preview-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .preview-box {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }

        .preview-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid #e0e0e0;
        }

        .preview-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 4px;
            display: block;
            margin: 0 auto;
        }

        .image-info {
            margin-top: 10px;
            font-size: 0.85em;
            color: #666;
            text-align: center;
        }

        .control-panel {
            background: #f5f7fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        input[type="range"] {
            width: 100%;
            margin: 10px 0;
        }

        input[type="number"], select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #4a90e2;
        }

        .range-value {
            display: inline-block;
            margin-left: 10px;
            color: #4a90e2;
            font-weight: bold;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.3s;
            margin-top: 10px;
        }

        .btn:hover {
            background: #3a7bc8;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .crop-preview {
            position: relative;
            display: inline-block;
            margin: 20px auto;
            border: 2px solid #4a90e2;
        }

        .crop-overlay {
            position: absolute;
            border: 2px dashed #4a90e2;
            background: rgba(102, 126, 234, 0.1);
            cursor: move;
        }

        .crop-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #4a90e2;
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            cursor: nwse-resize;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 12px;
            border-radius: 4px;
            font-size: 0.85em;
            color: #666;
            margin-top: 15px;
        }

        @media (max-width: 968px) {
            .preview-section {
                grid-template-columns: 1fr;
            }
            .container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
        <div class="header">
            <h1>ğŸ–¼ï¸ å›¾ç‰‡å¤„ç†å·¥å…·</h1>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('compress')">å›¾ç‰‡å‹ç¼©</button>
            <button class="tab" onclick="switchTab('resize')">å›¾ç‰‡æ”¾å¤§</button>
            <button class="tab" onclick="switchTab('crop')">ç­‰æ¯”ä¾‹è£å‰ª</button>
        </div>

        <!-- å›¾ç‰‡ä¸Šä¼ åŒºåŸŸ -->
        <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
            <div class="upload-icon">ğŸ“</div>
            <div>ç‚¹å‡»é€‰æ‹©å›¾ç‰‡æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</div>
            <div class="upload-text">æ”¯æŒ JPGã€PNGã€GIFã€WEBP æ ¼å¼</div>
            <input type="file" id="fileInput" accept="image/*">
        </div>

        <!-- å›¾ç‰‡å‹ç¼© -->
        <div id="compressTab" class="tab-content active">
            <div class="control-panel">
                <div class="form-group">
                    <label>
                        å‹ç¼©è´¨é‡
                        <span class="range-value" id="qualityValue">80</span>%
                    </label>
                    <input type="range" id="qualitySlider" min="10" max="100" value="80" oninput="updateQualityValue()">
                </div>
                <div class="form-group">
                    <label>è¾“å‡ºæ ¼å¼</label>
                    <select id="compressFormat">
                        <option value="jpeg">JPEG</option>
                        <option value="png">PNG</option>
                        <option value="webp">WEBP</option>
                    </select>
                </div>
                <button class="btn" onclick="compressImage()">å‹ç¼©å›¾ç‰‡</button>
                <button class="btn btn-success" onclick="downloadImage('compressed')">ä¸‹è½½å‹ç¼©å›¾ç‰‡</button>
            </div>
            <div class="preview-section">
                <div class="preview-box">
                    <div class="preview-title">åŸå›¾</div>
                    <img id="originalImage" class="preview-image" style="display: none;">
                    <div class="image-info" id="originalInfo"></div>
                </div>
                <div class="preview-box">
                    <div class="preview-title">å‹ç¼©å</div>
                    <img id="compressedImage" class="preview-image" style="display: none;">
                    <div class="image-info" id="compressedInfo"></div>
                </div>
            </div>
        </div>

        <!-- å›¾ç‰‡æ”¾å¤§ -->
        <div id="resizeTab" class="tab-content">
            <div class="control-panel">
                <div class="form-group">
                    <label>
                        æ”¾å¤§å€æ•°
                        <span class="range-value" id="scaleValue">2</span>x
                    </label>
                    <input type="range" id="scaleSlider" min="1" max="5" step="0.1" value="2" oninput="updateScaleValue()">
                </div>
                <div class="form-group">
                    <label>æˆ–æŒ‡å®šå®½åº¦ï¼ˆåƒç´ ï¼‰</label>
                    <input type="number" id="targetWidth" placeholder="ç•™ç©ºåˆ™æŒ‰å€æ•°æ”¾å¤§" min="1">
                </div>
                <div class="form-group">
                    <label>æˆ–æŒ‡å®šé«˜åº¦ï¼ˆåƒç´ ï¼‰</label>
                    <input type="number" id="targetHeight" placeholder="ç•™ç©ºåˆ™æŒ‰å€æ•°æ”¾å¤§" min="1">
                </div>
                <div class="form-group">
                    <label>ç¼©æ”¾ç®—æ³•</label>
                    <select id="resizeAlgorithm">
                        <option value="default">é»˜è®¤ï¼ˆå¿«é€Ÿï¼‰</option>
                        <option value="highQuality">é«˜è´¨é‡</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>
                        è¾“å‡ºè´¨é‡
                        <span class="range-value" id="resizeQualityValue">100</span>%
                    </label>
                    <input type="range" id="resizeQualitySlider" min="80" max="100" value="100" oninput="updateResizeQualityValue()">
                </div>
                <div class="form-group">
                    <label>è¾“å‡ºæ ¼å¼</label>
                    <select id="resizeFormat">
                        <option value="png">PNGï¼ˆæ— æŸï¼Œæ–‡ä»¶è¾ƒå¤§ï¼‰</option>
                        <option value="jpeg">JPEGï¼ˆæœ‰æŸï¼Œå¯æ§åˆ¶è´¨é‡ï¼‰</option>
                        <option value="webp">WEBPï¼ˆç°ä»£æ ¼å¼ï¼‰</option>
                    </select>
                </div>
                <button class="btn" onclick="resizeImage()">æ”¾å¤§å›¾ç‰‡</button>
                <button class="btn btn-success" onclick="downloadImage('resized')">ä¸‹è½½æ”¾å¤§å›¾ç‰‡</button>
            </div>
            <div class="preview-section">
                <div class="preview-box">
                    <div class="preview-title">åŸå›¾</div>
                    <img id="originalImage2" class="preview-image" style="display: none;">
                    <div class="image-info" id="originalInfo2"></div>
                </div>
                <div class="preview-box">
                    <div class="preview-title">æ”¾å¤§å</div>
                    <img id="resizedImage" class="preview-image" style="display: none;">
                    <div class="image-info" id="resizedInfo"></div>
                </div>
            </div>
        </div>

        <!-- ç­‰æ¯”ä¾‹è£å‰ª -->
        <div id="cropTab" class="tab-content">
            <div class="control-panel">
                <div class="form-group">
                    <label>è£å‰ªæ¯”ä¾‹</label>
                    <select id="cropRatio" onchange="updateCropRatio()">
                        <option value="free">è‡ªç”±è£å‰ª</option>
                        <option value="1:1">1:1 (æ­£æ–¹å½¢)</option>
                        <option value="4:3">4:3</option>
                        <option value="3:4">3:4</option>
                        <option value="16:9">16:9</option>
                        <option value="9:16">9:16</option>
                        <option value="3:2">3:2</option>
                        <option value="2:3">2:3</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>è£å‰ªåŒºåŸŸå¤§å°ï¼ˆåƒç´ ï¼‰</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="number" id="cropWidth" placeholder="å®½åº¦" min="1">
                        <input type="number" id="cropHeight" placeholder="é«˜åº¦" min="1">
                    </div>
                </div>
                <button class="btn" onclick="cropImage()">è£å‰ªå›¾ç‰‡</button>
                <button class="btn btn-success" onclick="downloadImage('cropped')">ä¸‹è½½è£å‰ªå›¾ç‰‡</button>
            </div>
            <div class="preview-section">
                <div class="preview-box">
                    <div class="preview-title">åŸå›¾</div>
                    <div style="text-align: center; position: relative; display: inline-block; width: 100%;">
                        <img id="originalImage3" class="preview-image" style="display: none; max-width: 100%;">
                        <canvas id="cropCanvas" style="display: none; max-width: 100%; border: 2px solid #4a90e2;"></canvas>
                    </div>
                    <div class="image-info" id="originalInfo3"></div>
                </div>
                <div class="preview-box">
                    <div class="preview-title">è£å‰ªå</div>
                    <img id="croppedImage" class="preview-image" style="display: none;">
                    <div class="image-info" id="croppedInfo"></div>
                </div>
            </div>
        </div>

        <div class="info-box">
            <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
            â€¢ æ”¯æŒæ‹–æ‹½ä¸Šä¼ æˆ–ç‚¹å‡»é€‰æ‹©å›¾ç‰‡<br>
            â€¢ å›¾ç‰‡å‹ç¼©ï¼šè°ƒæ•´è´¨é‡ç™¾åˆ†æ¯”ï¼Œæ•°å€¼è¶Šå°æ–‡ä»¶è¶Šå°<br>
            â€¢ å›¾ç‰‡æ”¾å¤§ï¼šå¯é€‰æ‹©å€æ•°æˆ–æŒ‡å®šå°ºå¯¸ï¼Œæ”¯æŒé«˜è´¨é‡ç®—æ³•ï¼Œå¯è®¾ç½®è¾“å‡ºè´¨é‡å’Œæ ¼å¼ä»¥å¢åŠ æ–‡ä»¶å¤§å°<br>
            â€¢ ç­‰æ¯”ä¾‹è£å‰ªï¼šé€‰æ‹©é¢„è®¾æ¯”ä¾‹æˆ–è‡ªå®šä¹‰å°ºå¯¸<br>
            â€¢ æ‰€æœ‰å¤„ç†éƒ½åœ¨æµè§ˆå™¨æœ¬åœ°å®Œæˆï¼Œä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨
        </div>
    </div>

    <script>
        let currentImage = null;
        let currentImageData = null;
        let compressedCanvas = null;
        let resizedCanvas = null;
        let croppedCanvas = null;

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }

        // æ–‡ä»¶ä¸Šä¼ 
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    currentImage = img;
                    currentImageData = { width: img.width, height: img.height, size: file.size };
                    
                    // æ˜¾ç¤ºåŸå›¾
                    displayOriginalImage(img, file.size);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function displayOriginalImage(img, fileSize) {
            // å‹ç¼©æ ‡ç­¾é¡µ
            document.getElementById('originalImage').src = img.src;
            document.getElementById('originalImage').style.display = 'block';
            document.getElementById('originalInfo').textContent = 
                `${img.width} Ã— ${img.height}px | ${formatFileSize(fileSize)}`;

            // æ”¾å¤§æ ‡ç­¾é¡µ
            document.getElementById('originalImage2').src = img.src;
            document.getElementById('originalImage2').style.display = 'block';
            document.getElementById('originalInfo2').textContent = 
                `${img.width} Ã— ${img.height}px | ${formatFileSize(fileSize)}`;

            // è£å‰ªæ ‡ç­¾é¡µ
            document.getElementById('originalImage3').src = img.src;
            document.getElementById('originalImage3').style.display = 'block';
            document.getElementById('originalInfo3').textContent = 
                `${img.width} Ã— ${img.height}px | ${formatFileSize(fileSize)}`;
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        // æ›´æ–°è´¨é‡å€¼
        function updateQualityValue() {
            document.getElementById('qualityValue').textContent = document.getElementById('qualitySlider').value;
        }

        // æ›´æ–°å€æ•°å€¼
        function updateScaleValue() {
            document.getElementById('scaleValue').textContent = document.getElementById('scaleSlider').value;
        }

        // æ›´æ–°æ”¾å¤§è´¨é‡å€¼
        function updateResizeQualityValue() {
            document.getElementById('resizeQualityValue').textContent = document.getElementById('resizeQualitySlider').value;
        }

        // å›¾ç‰‡å‹ç¼©
        function compressImage() {
            if (!currentImage) {
                alert('è¯·å…ˆé€‰æ‹©å›¾ç‰‡');
                return;
            }

            const quality = document.getElementById('qualitySlider').value / 100;
            const format = document.getElementById('compressFormat').value;
            const mimeType = format === 'jpeg' ? 'image/jpeg' : format === 'png' ? 'image/png' : 'image/webp';

            compressedCanvas = document.createElement('canvas');
            compressedCanvas.width = currentImage.width;
            compressedCanvas.height = currentImage.height;
            const ctx = compressedCanvas.getContext('2d');
            ctx.drawImage(currentImage, 0, 0);

            const dataUrl = compressedCanvas.toDataURL(mimeType, quality);
            const img = new Image();
            img.onload = () => {
                document.getElementById('compressedImage').src = dataUrl;
                document.getElementById('compressedImage').style.display = 'block';
                
                // è®¡ç®—æ–‡ä»¶å¤§å°
                const base64Length = dataUrl.length - (dataUrl.indexOf(',') + 1);
                const fileSize = base64Length * 0.75;
                document.getElementById('compressedInfo').textContent = 
                    `${currentImage.width} Ã— ${currentImage.height}px | ${formatFileSize(fileSize)}`;
            };
            img.src = dataUrl;
        }

        // å›¾ç‰‡æ”¾å¤§
        function resizeImage() {
            if (!currentImage) {
                alert('è¯·å…ˆé€‰æ‹©å›¾ç‰‡');
                return;
            }

            const scale = parseFloat(document.getElementById('scaleSlider').value);
            const targetWidth = parseInt(document.getElementById('targetWidth').value);
            const targetHeight = parseInt(document.getElementById('targetHeight').value);
            const algorithm = document.getElementById('resizeAlgorithm').value;
            const quality = document.getElementById('resizeQualitySlider').value / 100;
            const format = document.getElementById('resizeFormat').value;

            let newWidth, newHeight;

            if (targetWidth && targetHeight) {
                newWidth = targetWidth;
                newHeight = targetHeight;
            } else if (targetWidth) {
                newWidth = targetWidth;
                newHeight = Math.round(currentImage.height * (targetWidth / currentImage.width));
            } else if (targetHeight) {
                newHeight = targetHeight;
                newWidth = Math.round(currentImage.width * (targetHeight / currentImage.height));
            } else {
                newWidth = Math.round(currentImage.width * scale);
                newHeight = Math.round(currentImage.height * scale);
            }

            resizedCanvas = document.createElement('canvas');
            resizedCanvas.width = newWidth;
            resizedCanvas.height = newHeight;
            const ctx = resizedCanvas.getContext('2d');

            if (algorithm === 'highQuality') {
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
            } else {
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'medium';
            }

            ctx.drawImage(currentImage, 0, 0, newWidth, newHeight);

            // æ ¹æ®æ ¼å¼é€‰æ‹©MIMEç±»å‹
            let mimeType = 'image/png';
            if (format === 'jpeg') {
                mimeType = 'image/jpeg';
            } else if (format === 'webp') {
                mimeType = 'image/webp';
            }

            // PNGæ ¼å¼ä¸æ”¯æŒè´¨é‡å‚æ•°ï¼Œä½¿ç”¨æœ€é«˜è´¨é‡
            const outputQuality = format === 'png' ? undefined : quality;

            const dataUrl = resizedCanvas.toDataURL(mimeType, outputQuality);
            const img = new Image();
            img.onload = () => {
                document.getElementById('resizedImage').src = dataUrl;
                document.getElementById('resizedImage').style.display = 'block';
                
                // è®¡ç®—æ–‡ä»¶å¤§å°
                const base64Length = dataUrl.length - (dataUrl.indexOf(',') + 1);
                const fileSize = base64Length * 0.75;
                const originalSize = currentImageData.size;
                const sizeIncrease = ((fileSize / originalSize - 1) * 100).toFixed(1);
                
                document.getElementById('resizedInfo').textContent = 
                    `${newWidth} Ã— ${newHeight}px | ${formatFileSize(fileSize)} | å¢åŠ  ${sizeIncrease}%`;
            };
            img.src = dataUrl;
        }

        // æ›´æ–°è£å‰ªæ¯”ä¾‹
        function updateCropRatio() {
            if (!currentImage) return;
            
            const ratio = document.getElementById('cropRatio').value;
            if (ratio === 'free') {
                document.getElementById('cropWidth').value = '';
                document.getElementById('cropHeight').value = '';
                return;
            }

            const [w, h] = ratio.split(':').map(Number);
            const imageRatio = currentImage.width / currentImage.height;
            const ratioValue = w / h;

            let cropWidth, cropHeight;
            if (imageRatio > ratioValue) {
                cropHeight = Math.min(currentImage.height, 500);
                cropWidth = Math.round(cropHeight * ratioValue);
            } else {
                cropWidth = Math.min(currentImage.width, 500);
                cropHeight = Math.round(cropWidth / ratioValue);
            }

            document.getElementById('cropWidth').value = cropWidth;
            document.getElementById('cropHeight').value = cropHeight;
        }

        // å›¾ç‰‡è£å‰ª
        function cropImage() {
            if (!currentImage) {
                alert('è¯·å…ˆé€‰æ‹©å›¾ç‰‡');
                return;
            }

            const cropWidth = parseInt(document.getElementById('cropWidth').value);
            const cropHeight = parseInt(document.getElementById('cropHeight').value);

            if (!cropWidth || !cropHeight) {
                alert('è¯·è¾“å…¥è£å‰ªå°ºå¯¸');
                return;
            }

            if (cropWidth > currentImage.width || cropHeight > currentImage.height) {
                alert('è£å‰ªå°ºå¯¸ä¸èƒ½è¶…è¿‡åŸå›¾å°ºå¯¸');
                return;
            }

            // è®¡ç®—è£å‰ªèµ·å§‹ä½ç½®ï¼ˆå±…ä¸­è£å‰ªï¼‰
            const startX = Math.floor((currentImage.width - cropWidth) / 2);
            const startY = Math.floor((currentImage.height - cropHeight) / 2);

            croppedCanvas = document.createElement('canvas');
            croppedCanvas.width = cropWidth;
            croppedCanvas.height = cropHeight;
            const ctx = croppedCanvas.getContext('2d');

            ctx.drawImage(
                currentImage,
                startX, startY, cropWidth, cropHeight,
                0, 0, cropWidth, cropHeight
            );

            const dataUrl = croppedCanvas.toDataURL('image/png');
            const img = new Image();
            img.onload = () => {
                document.getElementById('croppedImage').src = dataUrl;
                document.getElementById('croppedImage').style.display = 'block';
                document.getElementById('croppedInfo').textContent = 
                    `${cropWidth} Ã— ${cropHeight}px`;
            };
            img.src = dataUrl;
        }

        // ä¸‹è½½å›¾ç‰‡
        function downloadImage(type) {
            let canvas, filename;
            
            if (type === 'compressed') {
                canvas = compressedCanvas;
                filename = 'compressed_image';
            } else if (type === 'resized') {
                canvas = resizedCanvas;
                filename = 'resized_image';
            } else if (type === 'cropped') {
                canvas = croppedCanvas;
                filename = 'cropped_image';
            }

            if (!canvas) {
                alert('è¯·å…ˆå¤„ç†å›¾ç‰‡');
                return;
            }

            let format, mimeType, quality;
            
            if (type === 'compressed') {
                format = document.getElementById('compressFormat').value;
                mimeType = format === 'jpeg' ? 'image/jpeg' : format === 'png' ? 'image/png' : 'image/webp';
                quality = document.getElementById('qualitySlider').value / 100;
            } else if (type === 'resized') {
                format = document.getElementById('resizeFormat').value;
                mimeType = format === 'jpeg' ? 'image/jpeg' : format === 'png' ? 'image/png' : 'image/webp';
                quality = document.getElementById('resizeQualitySlider').value / 100;
                // PNGæ ¼å¼ä¸æ”¯æŒè´¨é‡å‚æ•°
                if (format === 'png') {
                    quality = undefined;
                }
            } else {
                format = 'png';
                mimeType = 'image/png';
                quality = undefined;
            }

            canvas.toBlob((blob) => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${filename}.${format}`;
                a.click();
                URL.revokeObjectURL(url);
            }, mimeType, quality);
        }
    </script>
</body>
</html>

